<!DOCTYPE html>
<html lang="es">

<head>
  <%- include('partials/head') %>
  <style>
    /* Ajustes para la tabla de empleados */
    .avatar-initials {
        width: 36px;
        height: 36px;
        background: linear-gradient(310deg, #5e72e4 0%, #825ee4 100%);
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 0.9rem;
    }
  </style>
</head>

<body class="g-sidenav-show bg-gray-100">
  
  <div class="min-height-300 position-absolute w-100 top-0"
       style="background-image: url('/assets/img/employees-cover.jpg'); background-size: cover; background-position: center center;">
      <span class="mask bg-gradient-primary opacity-6"></span>
  </div>

  <%- include('partials/sidebar', { page: 'employees' }) %>

  <main class="main-content position-relative border-radius-lg ">
    
    <%- include('partials/navbar', { page: 'Personal' }) %>

    <div class="container-fluid py-4">
      
      <% 
        let totalEmployees = employees.length;
        let withDebt = 0;
        
        employees.forEach(emp => {
            // Revisamos si tiene algún préstamo con estado 'prestado'
            let hasActiveLoan = emp.Loans && emp.Loans.some(loan => loan.status === 'prestado');
            if(hasActiveLoan) withDebt++;
        });

        let debtFree = totalEmployees - withDebt;
      %>

      <div class="row mb-4">
        
        <div class="col-xl-4 col-sm-6 mb-xl-0 mb-4">
          <div class="card">
            <div class="card-body p-3">
              <div class="row">
                <div class="col-8">
                  <div class="numbers">
                    <p class="text-sm mb-0 text-uppercase font-weight-bold">Plantilla Total</p>
                    <h5 class="font-weight-bolder"><%= totalEmployees %></h5>
                  </div>
                </div>
                <div class="col-4 text-end">
                  <div class="icon icon-shape bg-gradient-primary shadow-primary text-center rounded-circle">
                    <i class="fas fa-users text-lg opacity-10" aria-hidden="true"></i>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="col-xl-4 col-sm-6 mb-xl-0 mb-4">
          <div class="card">
            <div class="card-body p-3">
              <div class="row">
                <div class="col-8">
                  <div class="numbers">
                    <p class="text-sm mb-0 text-uppercase font-weight-bold">Con Adeudos</p>
                    <h5 class="font-weight-bolder text-danger"><%= withDebt %></h5>
                  </div>
                </div>
                <div class="col-4 text-end">
                  <div class="icon icon-shape bg-gradient-danger shadow-danger text-center rounded-circle">
                    <i class="fas fa-hand-holding-usd text-lg opacity-10" aria-hidden="true"></i>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="col-xl-4 col-sm-6 mb-xl-0 mb-4">
          <div class="card">
            <div class="card-body p-3">
              <div class="row">
                <div class="col-8">
                  <div class="numbers">
                    <p class="text-sm mb-0 text-uppercase font-weight-bold">Sin Pendientes</p>
                    <h5 class="font-weight-bolder text-success"><%= debtFree %></h5>
                  </div>
                </div>
                <div class="col-4 text-end">
                  <div class="icon icon-shape bg-gradient-success shadow-success text-center rounded-circle">
                    <i class="fas fa-check-circle text-lg opacity-10" aria-hidden="true"></i>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

      </div>

      <div class="row">
        <div class="col-12">
          <div class="card mb-4">
            
            <div class="card-header pb-0 d-flex justify-content-between align-items-center">
              <h6>Directorio de Personal</h6>
              <button type="button" class="btn bg-gradient-primary btn-sm mb-0" data-bs-toggle="modal" data-bs-target="#modalAddEmployee">
                <i class="fas fa-plus"></i> Nuevo Empleado
              </button>
            </div>

            <div class="card-body px-0 pt-0 pb-2">
              <div class="table-responsive p-0">
                <table class="table align-items-center mb-0">
                  <thead>
                    <tr>
                      <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Colaborador</th>
                      <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Estado</th>
                      <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Acciones</th>
                    </tr>
                  </thead>
                  <tbody>
                    <% employees.forEach(emp => { 
                        // Verificamos deuda por cada fila
                        let activeLoansCount = emp.Loans ? emp.Loans.filter(l => l.status === 'prestado').length : 0;
                    %>
                      <tr>
                        <td>
                          <div class="d-flex px-3 py-1">
                            <div>
                                <div class="avatar-initials me-3">
                                    <%= emp.name.charAt(0) %>
                                </div>
                            </div>
                            <div class="d-flex flex-column justify-content-center">
                              <h6 class="mb-0 text-sm"><%= emp.name %></h6>
                              <p class="text-xs text-secondary mb-0">ID: <%= emp.id %></p>
                            </div>
                          </div>
                        </td>
                        
                        <td class="align-middle text-center text-sm">
                            <% if(activeLoansCount > 0) { %>
                                <span class="badge badge-sm bg-gradient-danger">Debe <%= activeLoansCount %> items</span>
                            <% } else { %>
                                <span class="badge badge-sm bg-gradient-success">Libre</span>
                            <% } %>
                        </td>
                        
                        <td class="align-middle text-center">
                            <a href="/employees/<%= emp.id %>" class="btn btn-link text-primary px-3 mb-0" data-bs-toggle="tooltip" title="Ver Perfil">
                                <i class="fas fa-eye text-primary me-2" aria-hidden="true"></i> Perfil
                            </a>

                            <a href="javascript:;" onclick="confirmarEliminarEmpleado('<%= emp.id %>', '<%= emp.name %>')" class="btn btn-link text-danger px-3 mb-0" data-bs-toggle="tooltip" title="Eliminar Empleado">
                                <i class="fas fa-trash text-danger me-2" aria-hidden="true"></i> Borrar
                            </a>
                        </td>
                      </tr>
                    <% }) %>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>

      <footer class="footer pt-3">
        <div class="container-fluid">
          <div class="row align-items-center justify-content-lg-between">
            <div class="col-lg-6 mb-lg-0 mb-4">
              <div class="copyright text-center text-sm text-muted text-lg-start">
                © <%= new Date().getFullYear() %> ATN Fabricaciones S.A. de C.V.
              </div>
            </div>
          </div>
        </div>
      </footer>

    </div>
  </main>

  <div class="modal fade" id="modalAddEmployee" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Registrar Nuevo Colaborador</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <form action="/employees/add" method="POST">
            <div class="modal-body">
                <div class="form-group">
                    <label for="name" class="form-control-label">Nombre Completo</label>
                    <input class="form-control" type="text" name="name" placeholder="Ej: Juan Pérez" required style="text-transform: uppercase;">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn bg-gradient-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="submit" class="btn bg-gradient-primary">Guardar</button>
            </div>
        </form>
      </div>
    </div>
  </div>

  <form id="formEliminarEmpleado" method="POST" style="display: none;"></form>

  <%- include('partials/scripts') %>

  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <script>
    // Función para confirmar eliminación de empleado
    function confirmarEliminarEmpleado(id, nombre) {
        Swal.fire({
            title: '¿Eliminar a ' + nombre + '?',
            text: "Se borrará su historial y acceso. ¡No se puede deshacer!",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#f5365c', // Rojo
            cancelButtonColor: '#2dce89',  // Verde
            confirmButtonText: 'Sí, borrar empleado',
            cancelButtonText: 'Cancelar',
            reverseButtons: true
        }).then((result) => {
            if (result.isConfirmed) {
                // Si confirma, enviamos el formulario
                var form = document.getElementById('formEliminarEmpleado');
                form.action = '/employees/delete/' + id;
                form.submit();
            }
        })
    }
  </script>
  
</body>
</html>